define(function(e,a,t){a.init=function(a){e(["mailbox.module.thread"],function(e){e.thread(a.find("#thread-list"))}),e(["mailbox.module.contract"],function(e){e.contract(a)}),e(["mailbox.module.reply"],function(e){e.reply(a)}),e(["mailbox.module.reply"],function(e){e.quickreply(a)}),e(["mailbox.module.compose"],function(e){e.compose(a.find("#thread-list"))})}}),define("mailbox.module.thread",["dynatable","mustache","timeago"],function(e,a,t){return{thread:function(e){var t=e.find("#thread-item").html(),n=$(".filter-form");return e.on("dynatable:init",function(a,t){e.on("click",".thread-info a",function(e){$("li.item").removeClass("is_active"),$(e.currentTarget).closest("li.item").addClass("is_read is_active")}),$(".btn-bar").on("click",".btn-query",function(e){t.paginationPage.set(1),t.process()})}),e.on("dynatable:afterUpdate",function(e){$(e.currentTarget).find("div.timeago").timeago();var a=$(".message-wrapper").find(".thread-info[data-id]").data("id");$(e.currentTarget).find('li.item[data-thread-id="'+a+'"]').addClass("is_active")}),e.on("dynatable:beforeProcess",function(e,a){a.status=n.find('input[name="status"]:checked').val(),a.message_date=n.find('input[name="message_date"]').val(),a.subject=n.find('input[name="subject"]').val(),a.licensee=n.find('select[name="licensee"]').val()}),e.dynatable({table:{bodyRowSelector:"li"},dataset:{ajax:!0,ajaxUrl:"/mailbox",ajaxOnLoad:!0,ajaxCache:!1,records:[],perPageDefault:50},writers:{_rowWriter:function(e,n,r,o){return a.render(t,{id:n.id,subject:n.subject,message:n.message,sender:n.sender,link:n.link,licensee:n.licensee,company_name:n.company_name,updated_at:n.updated_at,status:n.status,re:n.re})}},params:{records:"data",offset:"start",perPage:"length",totalRecordCount:"recordsTotal",queryRecordCount:"recordsFiltered"},features:{recordCount:!1,search:!1,sort:!1,pushState:!1,perPageSelect:!1},inputs:{paginationPrev:"<",paginationNext:">"}}).data("dynatable")}}}),define("mailbox.module.contract",["sweetalert2","mustache","datatables","moment","jqueryui"],function(e,a,t,n){return{contract:function(t){var r=$("#thread-list").find("#find-contract").html();t.on("click",".btn-find-contract",function(o){e.showLoading(),$.getJSON("mailbox/contract/"+$(o.currentTarget).data("id"),function(o){e.fire({title:"Select Contract",html:a.render(r,{subject:t.find(".message-wrapper .thread-info").data("subject")}),showConfirmButton:!1,showCloseButton:!0,position:"top-start",backdrop:!1,allowOutsideClick:!1,onOpen:function(a){var t=$(a).find("table").DataTable({sorting:!1,ordering:!1,paging:!1,order:[[1,"asc"]],dom:'rt<"clear">',language:{sLengthMenu:"Show _MENU_",processing:!1,emptyTable:"No matching records found or item(s) has been added/removed. Enter atleast 3 characters to search.",zeroRecords:"No matching records found or item(s) has been added/removed. Enter atleast 3 characters to search."},data:o,columns:[{data:"contract_type"},{data:"contract_no",fnCreatedCell:function(e,a,t,n,r){$(e).html('<a class="announcement-highlight" href="contract-management/contracts/'+t.id+'" target="_blank">'+t.contract_no+"</a>")}},{data:"contract_date",fnCreatedCell:function(e,a,t,r,o){$(e).html(n(t.contract_date,"YYYY-MM-DD").format("DD/MM/YYYY"))}},{data:"submitted_by"}]});$(a).find(".btn-search-contract").on("click",function(e){var n=$(a).find(".search-contract").val();$.getJSON("mailbox/contract/search",{contract_no:n},function(e){t.clear().draw(),t.rows.add(e),t.columns.adjust().draw()})}),$(e.getContainer()).draggable({cancel:".swal2-content"})},onClose:function(a){$(a).find("table").DataTable().destroy(),$(a).find(".btn-search-contract").off("click"),$(e.getContainer()).draggable("destroy")}})})})}}}),define("mailbox.module.reply",["sweetalert2","summernote"],function(e,a){return{reply:function(a){a.find(".message-reply textarea").summernote({height:150,toolbar:[["style",["bold","italic","underline","clear"]],["para",["ul","ol","paragraph"]]]}),a.on("click",".message-wrapper .btn-reply",function(t){var n=a.find(".message-wrapper .thread-info").data("id");e.fire({title:"Subject: "+a.find(".message-wrapper .thread-info").data("subject"),input:"textarea",width:800,customClass:"swal2-mailbox",showCancelButton:!0,confirmButtonText:'<i class="fa fa-paper-plane"></i> Send',showLoaderOnConfirm:!0,cancelButtonText:'<i class="fa fa-times"></i> Cancel',reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(a){if(""!=a)return $.ajax({url:"/mailbox/"+n,type:"PUT",data:{message:a},success:function(e){up.replace(".message-wrapper","/mailbox/"+n,{cache:!1});var a=$('li[data-thread-id="'+n+'"]');a.find(".preview .sender").html(e.sender),a.find(".preview .message").html(e.message),a.find(".preview .updated_at").html(e.updated_at)}});e.showValidationMessage("Message must not be empty")},onOpen:function(e){$(e).find("textarea.swal2-textarea").summernote({height:200,toolbar:[["style",["bold","italic","underline","clear"]],["para",["ul","ol","paragraph"]]],popover:{image:[],link:[],air:[]},hint:{mentions:["jay den","sam sung","alvin","david"],match:/\B@(\w*)$/,search:function(e,a){console.log(e),a($.grep(this.mentions,function(a){return 0==a.indexOf(e)}))},content:function(e){return $('<a href="https://google.com">test</a>')[0]}}}),$(e).find("textarea.swal2-textarea").focus()}})})},quickreply:function(e){e.on("click",".message-wrapper .btn-quickreply",function(a){a.preventDefault(),$(".message-wrapper .stage").show();var t=e.find(".message-wrapper .thread-info").data("id");$.ajax({url:"/mailbox/"+t,type:"PUT",data:{message:$(a.currentTarget).val()},success:function(e){up.replace(".message-wrapper","/mailbox/"+t,{cache:!1});var a=$('li[data-thread-id="'+t+'"]');a.find(".preview .sender").html(e.sender),a.find(".preview .message").html(e.message),a.find(".preview .updated_at").html(e.updated_at)}})})}}}),define("mailbox.module.compose",["sweetalert2","summernote","mustache"],function(e,a,t){return{compose:function(a){var n=a.find("#thread-compose").html();$(".mailbox-sidebar").on("click",".btn-add",function(r){e.fire({title:"Compose",html:t.render(n),input:"textarea",width:800,showCancelButton:!0,confirmButtonText:'<i class="fa fa-paper-plane"></i> Send',showLoaderOnConfirm:!0,cancelButtonText:'<i class="fa fa-times"></i> Cancel',customClass:"swal2-compose",reverseButtons:!0,allowOutsideClick:!1,preConfirm:function(t){var n=$(".swal2-compose").find('input[name="subject"]').val(),r=$(".swal2-compose").find('select[name="licensee"]').val();if(""==t)e.showValidationMessage("Message must not be empty");else if(""==n)e.showValidationMessage("Subject must not be empty");else{if(""!=r)return $.ajax({url:"/mailbox",type:"POST",data:{subject:n,licensee:r,message:t},success:function(e){var t=e.thread.id;up.replace(".message-wrapper","/mailbox/"+t,{cache:!1}).then(function(){a.on("dynatable:afterProcess",function(){$("li[data-thread-id]").removeClass("is_active"),$('li[data-thread-id="'+t+'"]').addClass("is_active"),a.off("dynatable:afterProcess")}),a.data("dynatable").process()})}});e.showValidationMessage("Licensee must not be empty")}},onOpen:function(e){$(e).find("input[name=subject]").focus(),$(e).find("textarea.swal2-textarea").summernote({height:200,toolbar:[["style",["bold","italic","underline","clear"]],["para",["ul","ol","paragraph"]]],popover:{image:[],link:[],air:[]}}),$(e).find('select[name="licensee"]').select2({ajax:{id:"id",url:"/filter/licenseesuser",dataType:"json",delay:250,data:function(e){return{search:e.term,page:e.page||1}},processResults:function(e,a){return a.page=a.page||1,{results:e.data,pagination:{more:50*a.page<e.total}}},cache:!0},minimumInputLength:3,dropdownAutoWidth:!0,escapeMarkup:function(e){return e},templateResult:function(e){return e.loading?e.text:"<div>"+e.username+' - <span class="license-no">'+(e.company.license_no.length>0?e.company.license_no[0].license_no:"")+'</span> - <span class="name">'+e.company.company_name+"</span></div>"},templateSelection:function(e){return e.username?e.username+" "+e.company.license_no[0].license_no+" - "+e.company.company_name:e.text}})}})})}}});
